# Pin Lima VM images for reproducible builds (2025-05-20 daily build)
images:
  - location: https://cloud.debian.org/images/cloud/trixie/20251117-2299/debian-13-genericcloud-amd64-20251117-2299.qcow2
    arch: x86_64
  - location: https://cloud.debian.org/images/cloud/trixie/20251117-2299/debian-13-genericcloud-arm64-20251117-2299.qcow2
    arch: aarch64
cpus: 6
memory: 12GiB
disk: 160GiB
user:
  name: debian
  uid: 1000
  home: /home/debian
rosetta:
  enabled: true
  binfmt: true
containerd:
   # Otherwise lima will install couple of hundreds of MB of containerd stuff,
   # which we don't need.
  user: false
mountTypesUnsupported: [9p]
mounts:
  - location: ABSOLUTE_IMAGES_PATH
    mountPoint: /home/debian/mnt
    writable: true
  - location: ABSOLUTE_IMAGES_PATH/../kettle-sgx
    mountPoint: /home/debian/mnt/kettle-sgx
    writable: false
ssh:
  forwardAgent: true
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -euo pipefail
      apt-get update
      apt-get install -y curl git sudo debian-archive-keyring build-essential uidmap
      echo "debian ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/debian
  - mode: user
    script: |
      #!/bin/bash
      set -euo pipefail

      mkdir -p ~/.config/nix
      echo 'experimental-features = nix-command flakes' > ~/.config/nix/nix.conf
      echo 'extra-platforms = x86_64-linux' >> ~/.config/nix/nix.conf
      sh <(curl -L https://nixos.org/nix/install) --no-daemon --nix-extra-conf-file ~/.config/nix/nix.conf

      # nix adds its env to .profile, but not to .bashrc
      # .profile is not sourced when connecting through ssh, so copy to .bashrc
      grep nix .profile >> .bashrc
