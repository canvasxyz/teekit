#!/bin/bash
set -euo pipefail

# Azure-specific cloud configuration script
# This script runs on Azure VMs to fetch the manifest from instance metadata

LOG_PREFIX="[config_azure]"
CONFIG_DIR="/etc/kettle"
ENV_FILE="$CONFIG_DIR/cloud-launcher.env"
DEFAULT_TRUSTAUTHORITY_API_URL="https://api.trustauthority.intel.com"

echo "$LOG_PREFIX Fetching manifest from Azure metadata service..."

# Fetch manifest from Azure instance metadata
# The manifest should be set as a custom tag named "manifest"
# Can be a single base64 string or comma-separated list of base64 strings
TAGS_JSON=$(curl -s -f -H "Metadata: true" \
  "http://169.254.169.254/metadata/instance/compute/tagsList?api-version=2021-02-01" || echo "[]")

# Extract manifest and hostname values using Python (available in the VM)
MANIFEST=$(python3 -c "
import json, sys
try:
    tags = json.loads('$TAGS_JSON')
    for tag in tags:
        if tag.get('name') == 'manifest':
            print(tag.get('value', ''))
            break
except:
    pass
" || echo "")

# Fetch hostname configuration (optional, but fetch before early exit)
HOSTNAME_CONFIG=$(python3 -c "
import json, sys
try:
    tags = json.loads('$TAGS_JSON')
    for tag in tags:
        if tag.get('name') == 'hostname':
            print(tag.get('value', ''))
            break
except:
    pass
" || echo "")

# Fetch Trust Authority configuration (optional)
TRUSTAUTHORITY_API_URL=$(python3 -c "
import json, sys
try:
    tags = json.loads('$TAGS_JSON')
    for tag in tags:
        if tag.get('name') == 'trustauthority_api_url':
            print(tag.get('value', ''))
            break
except:
    pass
" || echo "")

TRUSTAUTHORITY_API_KEY=$(python3 -c "
import json, sys
try:
    tags = json.loads('$TAGS_JSON')
    for tag in tags:
        if tag.get('name') == 'trustauthority_api_key':
            print(tag.get('value', ''))
            break
except:
    pass
" || echo "")

if [ -n "$HOSTNAME_CONFIG" ]; then
  echo "$LOG_PREFIX Successfully fetched hostname configuration: $HOSTNAME_CONFIG"
else
  echo "$LOG_PREFIX No hostname configuration found (this is optional)"
fi

# Log Trust Authority configuration status
# API key is required; API URL defaults to $DEFAULT_TRUSTAUTHORITY_API_URL if not provided
if [ -n "$TRUSTAUTHORITY_API_KEY" ]; then
  if [ -z "$TRUSTAUTHORITY_API_URL" ]; then
    TRUSTAUTHORITY_API_URL="$DEFAULT_TRUSTAUTHORITY_API_URL"
    echo "$LOG_PREFIX Using default Trust Authority API URL: $TRUSTAUTHORITY_API_URL"
  fi
  echo "$LOG_PREFIX Successfully fetched Trust Authority configuration"
  echo "$LOG_PREFIX   API URL: $TRUSTAUTHORITY_API_URL"
  echo "$LOG_PREFIX   API Key: [redacted, length=${#TRUSTAUTHORITY_API_KEY}]"
else
  echo "$LOG_PREFIX No Trust Authority API key found (this is optional)"
fi

if [ -z "$MANIFEST" ]; then
  echo "$LOG_PREFIX No manifest tag found in Azure metadata"
  echo "$LOG_PREFIX Kettle will use default manifest if available"
  echo "$LOG_PREFIX To provide a manifest, create VM with: --tags manifest=\$(base64 -w0 manifest.json)"
  # Write env file with cloud provider and hostname (if present) so services can still use them
  echo "CLOUD_PROVIDER=azure" > "$ENV_FILE"
  if [ -n "$HOSTNAME_CONFIG" ]; then
    echo "HOSTNAME_CONFIG=$HOSTNAME_CONFIG" >> "$ENV_FILE"
  fi
  # Create Trust Authority config.json if API key is provided (URL defaults if not set)
  if [ -n "$TRUSTAUTHORITY_API_KEY" ]; then
    echo "$LOG_PREFIX Creating Trust Authority config.json..."
    cat > "$CONFIG_DIR/config.json" << EOF
{
  "trustauthority_api_url": "$TRUSTAUTHORITY_API_URL",
  "trustauthority_api_key": "$TRUSTAUTHORITY_API_KEY"
}
EOF
    echo "$LOG_PREFIX Trust Authority config.json created at $CONFIG_DIR/config.json"
  fi
  exit 0
fi

echo "$LOG_PREFIX Successfully fetched manifest from Azure metadata"

# Print the manifest(s) to the log
if [[ "$MANIFEST" == *","* ]]; then
  IFS=',' read -ra MANIFEST_ARRAY <<< "$MANIFEST"
  for i in "${!MANIFEST_ARRAY[@]}"; do
    if echo "${MANIFEST_ARRAY[$i]}" | base64 -d &>/dev/null; then
      echo "$LOG_PREFIX Manifest $i (decoded):"
      echo "${MANIFEST_ARRAY[$i]}" | base64 -d | sed 's/^/  /'
    else
      echo "$LOG_PREFIX Manifest $i does not appear to be base64-encoded"
    fi
  done
else
  if echo "$MANIFEST" | base64 -d &>/dev/null; then
    echo "$LOG_PREFIX Manifest (decoded):"
    echo "$MANIFEST" | base64 -d | sed 's/^/  /'
  else
    echo "$LOG_PREFIX Manifest does not appear to be base64-encoded"
  fi
fi

# Write environment file for kettle-launcher and certbot-launcher services
echo "MANIFEST=$MANIFEST" > "$ENV_FILE"
echo "CLOUD_PROVIDER=azure" >> "$ENV_FILE"
if [ -n "$HOSTNAME_CONFIG" ]; then
  echo "HOSTNAME_CONFIG=$HOSTNAME_CONFIG" >> "$ENV_FILE"
fi

# Create Trust Authority config.json if API key is provided (URL defaults if not set)
if [ -n "$TRUSTAUTHORITY_API_KEY" ]; then
  echo "$LOG_PREFIX Creating Trust Authority config.json..."
  cat > "$CONFIG_DIR/config.json" << EOF
{
  "trustauthority_api_url": "$TRUSTAUTHORITY_API_URL",
  "trustauthority_api_key": "$TRUSTAUTHORITY_API_KEY"
}
EOF
  echo "$LOG_PREFIX Trust Authority config.json created at $CONFIG_DIR/config.json"
fi

echo "$LOG_PREFIX Configuration complete"
