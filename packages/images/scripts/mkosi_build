#!/usr/bin/env bash

# Shorthand script for mkosi build commands.
#
# By default, preserves existing outputs (skips images that are already built).
#
# Use --cached to rebuild the current stage while reusing earlier cached stages.
# Use --clean to also clear the incremental cache (equivalent to --force --force).
# Supports any list of profiles passed afterwards.
#
# To clear the full package cache (equivalent to --force --force --force) use
# "npm run clean" instead.

set -euo pipefail

# Default to unix epoch, otherwise nix will default to fat32 epoch
export SOURCE_DATE_EPOCH="${SOURCE_DATE_EPOCH:-0}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IMAGES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$IMAGES_DIR"

echo "Running 'npm run build'..."
npm run build

# Default: single --force to rebuild all stages, while keeping artifact caches
force_args=(--force)
profiles=()
clear_current_stage=false

while (( "$#" )); do
  case "$1" in
    --cached)
      # Reuse earlier cached stages, but clear current stage output
      force_args=()
      clear_current_stage=true
      shift
      ;;
    --clean)
      # Double --force clears the incremental cache
      force_args=(--force --force)
      shift
      ;;
    *)
      profiles+=("$1")
      shift
      ;;
  esac
done

# Clear current stage output if --cached was specified
if [ "$clear_current_stage" = true ]; then
  echo "Clearing current stage output (keeping earlier cached stages)..."
  rm -f "$IMAGES_DIR/build/kettle-vm"*

  # Also clear mkosi output in Lima VM if it exists
  LIMA_VM="${LIMA_VM:-tee-builder}"
  if command -v limactl &>/dev/null && limactl list "$LIMA_VM" &>/dev/null; then
    status=$(limactl list "$LIMA_VM" --format "{{.Status}}" 2>/dev/null || echo "")
    if [ "$status" = "Running" ]; then
      echo "Clearing mkosi output in Lima VM..."
      ssh -F "$HOME/.lima/$LIMA_VM/ssh.config" "lima-$LIMA_VM" \
        -o LogLevel=QUIET \
        -- "rm -rf /home/debian/mkosi-output/*" 2>/dev/null || true
    fi
  fi
fi

if [ ${#profiles[@]} -eq 0 ]; then
  echo "Building default mkosi image (no profile)..."
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i ${force_args[@]+"${force_args[@]}"} -I kettle-vm.conf
  exit 0
fi

# Build profile flags for a single mkosi invocation
profile_args=()
profile_names=()

for profile in "${profiles[@]}"; do
  if [ "$profile" != "default" ]; then
    profile_args+=(--profile="$profile")
    profile_names+=("$profile")
  fi
done

if [ ${#profile_names[@]} -eq 0 ]; then
  echo "Building default mkosi image (no profile)..."
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i ${force_args[@]+"${force_args[@]}"} -I kettle-vm.conf
else
  echo "Building mkosi image with profiles: ${profile_names[*]}"
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i ${force_args[@]+"${force_args[@]}"} "${profile_args[@]}" -I kettle-vm.conf
fi
