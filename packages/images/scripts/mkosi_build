#!/usr/bin/env bash

# Shorthand script for mkosi build commands.
#
# By default, uses single --force to allow rebuilding over existing output while
# preserving the incremental cache.
#
# Use --clean to also clear the incremental cache (equivalent to --force --force).
# Supports any list of profiles passed afterwards.
#
# To clear the full package cache (equivalent to --force --force --force) use
# "npm run clean" instead.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IMAGES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$IMAGES_DIR"

echo "Running 'npm run build'..."
npm run build

# Default: single --force to allow rebuilding while preserving incremental cache
force_args=(--force)
profiles=()

while (( "$#" )); do
  case "$1" in
    --clean)
      # Double --force clears the incremental cache
      force_args=(--force --force)
      shift
      ;;
    *)
      profiles+=("$1")
      shift
      ;;
  esac
done

if [ ${#profiles[@]} -eq 0 ]; then
  echo "Building default mkosi image (no profile)..."
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i "${force_args[@]}" -I tdx-kettle.conf
  exit 0
fi

# Build profile flags for a single mkosi invocation
profile_args=()
profile_names=()

for profile in "${profiles[@]}"; do
  if [ "$profile" != "default" ]; then
    profile_args+=(--profile="$profile")
    profile_names+=("$profile")
  fi
done

if [ ${#profile_names[@]} -eq 0 ]; then
  echo "Building default mkosi image (no profile)..."
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i "${force_args[@]}" -I tdx-kettle.conf
else
  echo "Building mkosi image with profiles: ${profile_names[*]}"
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i "${force_args[@]}" "${profile_args[@]}" -I tdx-kettle.conf
fi
