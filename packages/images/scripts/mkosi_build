#!/usr/bin/env bash

# Shorthand script for mkosi build commands.
#
# By default, preserves existing outputs (skips images that are already built).
#
# Use --rebuild to force rebuilding while preserving incremental cache (--force).
# Use --clean to also clear the incremental cache (equivalent to --force --force).
# Supports any list of profiles passed afterwards.
#
# To clear the full package cache (equivalent to --force --force --force) use
# "npm run clean" instead.

set -euo pipefail

# Default to unix epoch, otherwise nix will default to fat32 epoch
export SOURCE_DATE_EPOCH="${SOURCE_DATE_EPOCH:-0}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IMAGES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$IMAGES_DIR"

echo "Running 'npm run build'..."
npm run build

# Default: no --force, preserves existing outputs
force_args=()
profiles=()

while (( "$#" )); do
  case "$1" in
    --rebuild)
      # Single --force to rebuild while preserving incremental cache
      force_args=(--force)
      shift
      ;;
    --clean)
      # Double --force clears the incremental cache
      force_args=(--force --force)
      shift
      ;;
    *)
      profiles+=("$1")
      shift
      ;;
  esac
done

if [ ${#profiles[@]} -eq 0 ]; then
  echo "Building default mkosi image (no profile)..."
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i ${force_args[@]+"${force_args[@]}"} -I tdx-kettle.conf
  exit 0
fi

# Build profile flags for a single mkosi invocation
profile_args=()
profile_names=()

for profile in "${profiles[@]}"; do
  if [ "$profile" != "default" ]; then
    profile_args+=(--profile="$profile")
    profile_names+=("$profile")
  fi
done

if [ ${#profile_names[@]} -eq 0 ]; then
  echo "Building default mkosi image (no profile)..."
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i ${force_args[@]+"${force_args[@]}"} -I tdx-kettle.conf
else
  echo "Building mkosi image with profiles: ${profile_names[*]}"
  bash "$SCRIPT_DIR/env_wrapper.sh" mkosi -i ${force_args[@]+"${force_args[@]}"} "${profile_args[@]}" -I tdx-kettle.conf
fi
