#!/usr/bin/env node
// This script generates embeddedSources.ts with the actual pre-built file content
// Run this before bundling the CLI

import { readFileSync, writeFileSync } from "fs"
import { join, dirname } from "path"
import { fileURLToPath } from "url"

const SCRIPT_DIR = dirname(fileURLToPath(import.meta.url))
const REPO_ROOT = join(SCRIPT_DIR, "..", "..")
const KETTLE_DIR = join(REPO_ROOT, "packages", "kettle")

// Read the pre-built files
const externalsJs = readFileSync(
  join(KETTLE_DIR, "dist", "externals.js"),
  "utf-8",
)
const workerJs = readFileSync(join(KETTLE_DIR, "dist", "worker.js"), "utf-8")

// Escape backticks and backslashes for template literals
function escapeForTemplate(str) {
  return str.replace(/\\/g, "\\\\").replace(/`/g, "\\`").replace(/\$/g, "\\$")
}

// Generate the TypeScript file
const content = `// This file is AUTO-GENERATED by generate-embedded-sources.js
// DO NOT EDIT - Run 'node packages/images/generate-embedded-sources.js' to regenerate

export const EXTERNALS_JS = \`${escapeForTemplate(externalsJs)}\`

export const WORKER_JS = \`${escapeForTemplate(workerJs)}\`
`

// Write to the services directory
const outputPath = join(KETTLE_DIR, "services", "embeddedSources.ts")
writeFileSync(outputPath, content)

console.log(`Generated ${outputPath}`)
console.log(`  EXTERNALS_JS: ${externalsJs.length} bytes`)
console.log(`  WORKER_JS: ${workerJs.length} bytes`)
